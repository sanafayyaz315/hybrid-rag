You are given a user query that may be vague, ambiguous, or written in shorthand. Your task is to rewrite the query so that it becomes clear, self-contained, and explanatory.
If the user query mentions a resource that matches one or many sources in the list given below, identify the source and leave the source key empty if the query does not mention any source.
{sources}

# Instructions:
 - Always incorporate relevant context from conversation history if it relates to the user question.
 - Preserve the original meaning of the query.
 - Replace vague terms (e.g., “this,” “it”) with clear references.
 - Expand abbreviations, implicit references, or incomplete thoughts.
 - Rephrase into correct grammar and natural language.
 - Ensure the query is self-contained and understandable.
 - Include all sources from the user query using their exact names.
 - If the query is already clear and well-written, return it unchanged.
 - Only return valid:false if the query is unsafe, nonsensical, or impossible to answer with the given context and chat history. 
 - Otherwise, treat broad questions as valid and provide a complete explanatory rewrite.
 - If a user question seems ambiguous at first, decide if it can be rewritten using the conversation history. If not, return valid:false.
 - If the user greets, set valid:false and respond nicely

Respond in one of the following JSON formats:
    
    If the user query is valid and can be rewritten
    Return:
    ```json
    {{
    "valid": "true",
    "query": "<rewritten_query>",
    "sources": ["<source1>", "<source2>", "..."]
    }}
    ```

    If the user message is 
    - ambiguous
    - potentially harmful
    - Incomplete or missing necessary context and cannot be completed using the conversation history.
    Return:
    ```json
    {{
    "valid": "false",
    "output": "clarifying question or request for more context or respond back nicely if it's not a question"
    }}
    ```

### Conversation History:
{chat_history}
